<!DOCTYPE html>
<html>
<head>
    <title>Sensor de Tensión - Monitor</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .chart-container {
            width: 100%;
            height: 500px;
            margin: 20px 0;
        }
        .value-display {
            font-size: 24px;
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .control-panel {
            margin: 20px 0;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 10px;
        }
        .mode-selector {
            margin-bottom: 20px;
        }
        .historical-controls {
            display: none;
            gap: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        .btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Monitor de Tensión</h1>
        
        <div class="control-panel">
            <div class="mode-selector">
                <label>Modo de visualización:</label>
                <select id="viewMode" onchange="toggleViewMode()">
                    <option value="realtime">Tiempo Real</option>
                    <option value="historical">Datos Históricos</option>
                </select>
            </div>

            <div id="historicalControls" class="historical-controls">
                <div>
                    <label>Desde:</label>
                    <input type="datetime-local" id="startDate">
                </div>
                <div>
                    <label>Hasta:</label>
                    <input type="datetime-local" id="endDate">
                </div>
                <button class="btn" onclick="loadHistoricalData()">Cargar Datos</button>
            </div>
        </div>

        <div id="value-display" class="value-display"></div>
        <div id="tension-chart" class="chart-container"></div>
    </div>

    <script>
        let isRealTimeMode = true;
        let updateInterval;
        
        // Configuración inicial del gráfico
        let trace = {
            x: [],
            y: [],
            mode: 'lines',
            name: 'Tensión'
        };

        let layout = {
            title: 'Tensión vs Tiempo',
            xaxis: { title: 'Tiempo' },
            yaxis: { title: 'Tensión (kg)' },
            shapes: [
                {
                    type: 'rect',
                    xref: 'paper',
                    yref: 'y',
                    x0: 0,
                    y0: 0,
                    x1: 1,
                    y1: 1000,
                    fillcolor: 'rgba(0,255,0,0.1)',
                    line: { width: 0 }
                },
                {
                    type: 'rect',
                    xref: 'paper',
                    yref: 'y',
                    x0: 0,
                    y0: 1000,
                    x1: 1,
                    y1: 1500,
                    fillcolor: 'rgba(255,255,0,0.1)',
                    line: { width: 0 }
                },
                {
                    type: 'rect',
                    xref: 'paper',
                    yref: 'y',
                    x0: 0,
                    y0: 1500,
                    x1: 1,
                    y1: 2000,
                    fillcolor: 'rgba(255,0,0,0.1)',
                    line: { width: 0 }
                }
            ]
        };

        Plotly.newPlot('tension-chart', [trace], layout);

        function toggleViewMode() {
            const mode = document.getElementById('viewMode').value;
            const historicalControls = document.getElementById('historicalControls');
            
            if (mode === 'realtime') {
                historicalControls.style.display = 'none';
                startRealTimeUpdates();
            } else {
                historicalControls.style.display = 'flex';
                stopRealTimeUpdates();
            }
        }

        function startRealTimeUpdates() {
            isRealTimeMode = true;
            // Cargar los últimos 100 datos al iniciar
            fetch('/get_latest_data')
                .then(response => response.json())
                .then(data => {
                    trace.x = data.timestamps;
                    trace.y = data.values;
                    Plotly.update('tension-chart', {x: [trace.x], y: [trace.y]});
                    
                    // Iniciar actualizaciones periódicas
                    updateInterval = setInterval(updateData, 1000);
                })
                .catch(error => console.error('Error:', error));
        }

        function stopRealTimeUpdates() {
            isRealTimeMode = false;
            clearInterval(updateInterval);
        }

        function loadHistoricalData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            fetch(`/get_historical_data?start=${startDate}&end=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    Plotly.update('tension-chart', {
                        x: [data.timestamps],
                        y: [data.values]
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        function updateData() {
            if (!isRealTimeMode) return;
            
            fetch('/get_data')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }

                    const valueDisplay = document.getElementById('value-display');
                    const value = data.current_value;
                    
                    let backgroundColor;
                    if (value <= 1000) {
                        backgroundColor = 'rgba(0,255,0,0.2)';
                    } else if (value <= 1500) {
                        backgroundColor = 'rgba(255,255,0,0.2)';
                    } else {
                        backgroundColor = 'rgba(255,0,0,0.2)';
                    }
                    
                    valueDisplay.style.backgroundColor = backgroundColor;
                    valueDisplay.textContent = `Tensión actual: ${value.toFixed(2)} kg`;

                    // Actualizar el gráfico
                    trace.x.push(data.timestamp);
                    trace.y.push(value);

                    // Mantener solo los últimos 100 puntos para tiempo real
                    if (trace.x.length > 100) {
                        trace.x.shift();
                        trace.y.shift();
                    }

                    Plotly.update('tension-chart', {
                        x: [trace.x],
                        y: [trace.y]
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        // Iniciar en modo tiempo real
        startRealTimeUpdates();
    </script>
</body>
</html>
